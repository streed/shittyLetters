{% extends "base.html" %}
{% block title %}Index{% endblock %}
{% block content %}
<div class="container">
  <div class="jumbotron">
    <div class="row"> 
      <h2>Giving a friend or family member some sass?</h2>
      <h2>Do you wanna turn your sass game up?</h2>
      <p class="lead">Send them a shitty letter from Shitty Letters. Fill out the form below and for $2.50 we'll mail out a random sassy or offensive phrase on a postcard to them.</p>
    </div>
  </div>
  {% raw %}
  <script id="postcard-template" type="text/x-handlebars-template">
    <div class="postcard-body">
      <div id="safe-area">
        <div class="message">
          <div class="message-inner">
            {{message}}
          </div>
        </div>
        <div class="line"></div>
        <div class="to">
          {{defaultValue full_name "Shitty Person"}}<br/>
          {{defaultValue address1 "123 Shitty St"}}<br/>
          {{#if address2}}
          {{address2}}<br />
          {{/if}}
          {{defaultValue city "Shitsville"}}, {{defaultValue state "SH"}} {{defaultValue postal_code "12345"}}<br/>
          US
        </div>
      </div>
    </div>
  </script>
  {% endraw %}
  <div class="row">
      <div class="col-lg-4">
        <div class="form-horizontal postcard-destination-form">
          <fieldset>
            <div class="page-header">
              <h2>Deserving Person</h2>
            </div>
            <div class="control-group">
              <label class="control-label">Full Name</label>
              <div class="controls">
                <input id="full-name" name="full-name" type="text" class="input-medium address" placeholder="Full Name">
                <p class="help-block"></p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Address Line 1</label>
              <div class="controls">
                <input id="address-line1" name="address-line1" type="text" class="input-medium address" placeholder="Address 1">
                <p class="help-block">Street address, P.O. box, company name, c/o</p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Address Line 2</label>
              <div class="controls">
                <input id="address-line2" name="address-line2" type="text" class="input-medium address" placeholder="Address 2">
                <p class="help-block">Apartment, suite , unit, building, floor, etc.</p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">City / Town</label>
              <div class="controls">
                <input id="city" name="city" type="text" class="input-medium address" placeholder="City">
                <p class="help-block"></p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">State</label>
              <div class="controls">
                <select id="region" name="region" class="form-control col-sm-2 address">
                  <option value="AK">AK</option>
                  <option value="AL">AL</option>
                  <option value="AR">AR</option>
                  <option value="AZ">AZ</option>
                  <option value="CA">CA</option>
                  <option value="CO">CO</option>
                  <option value="CT">CT</option>
                  <option value="DC">DC</option>
                  <option value="DE">DE</option>
                  <option value="FL">FL</option>
                  <option value="GA">GA</option>
                  <option value="HI">HI</option>
                  <option value="IA">IA</option>
                  <option value="ID">ID</option>
                  <option value="IL">IL</option>
                  <option value="IN">IN</option>
                  <option value="KS">KS</option>
                  <option value="KY">KY</option>
                  <option value="LA">LA</option>
                  <option value="MA">MA</option>
                  <option value="MD">MD</option>
                  <option value="ME">ME</option>
                  <option value="MI">MI</option>
                  <option value="MN">MN</option>
                  <option value="MO">MO</option>
                  <option value="MS">MS</option>
                  <option value="MT">MT</option>
                  <option value="NC">NC</option>
                  <option value="ND">ND</option>
                  <option value="NE">NE</option>
                  <option value="NH">NH</option>
                  <option value="NJ">NJ</option>
                  <option value="NM">NM</option>
                  <option value="NV">NV</option>
                  <option value="NY">NY</option>
                  <option value="OH">OH</option>
                  <option value="OK">OK</option>
                  <option value="OR">OR</option>
                  <option value="PA">PA</option>
                  <option value="RI">RI</option>
                  <option value="SC">SC</option>
                  <option value="SD">SD</option>
                  <option value="TN">TN</option>
                  <option value="TX">TX</option>
                  <option value="UT">UT</option>
                  <option value="VA">VA</option>
                  <option value="VT">VT</option>
                  <option value="WA">WA</option>
                  <option value="WI">WI</option>
                  <option value="WV">WV</option>
                  <option value="WY">WY</option>
                </select>
                <p class="help-block"></p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Zip / Postal Code</label>
              <div class="controls">
                <input id="postal-code" name="postal-code" type="text" placeholder="zip or postal" code" class="input-medium address" maxlength="5">
                <p class="help-block"></p>
              </div>
            </div>
            <button class="btn postcard-submit">Order Postcard</button>
          </fieldset>
        </div>
      </div>
      <div class="col-lg-8">
        <div class='preview-window'>
          <div class="page-header">
            <h2>Sample</h2>
          </div>
          <div class="panel postcard-body">
            <div class="postcard-preview">
            </div>
          </div>
            <div class='postcard-address-errors panel panel-danger'>
              <div class='panel-heading'>
                <h3 class='panel-title'>Something goofed with the address you gave!</h3>
              </div>
              <div class='panel-body postcard-address-errors-body'></div>
            </div>
          </div>
        </div>
        <div class='postcard-buy'>
          <div class="page-header">
            <h2>Purchase</h2>
          </div>
          <div class='col-md-4'>
            <div class='payment-form'>
              <div class='form-row'>
                <div class='col-xs-12 form-group required'>
                  <label class='control-label'>Email to send receipt</label>
                  <input class='form-control email' size='4' type='text' placeholder="Your email address">
                </div>
              </div>
              <div class='form-row'>
                <div class='col-xs-12 form-group required'>
                  <label class='control-label'>Name on Card</label>
                  <input class='form-control name' size='4' type='text' placeholder="Name as appears on card">
                </div>
              </div>
              <div class='form-row'>
                <div class='col-xs-12 form-group card required'>
                  <label class='control-label'>Card Number</label>
                  <input autocomplete='off' class='form-control card-number' size='20' type='text' placeholder="ex 1111222233334444">
                </div>
              </div>
              <div class='form-row'>
                <div class='col-xs-4 form-group cvc required'>
                  <label class='control-label'>CVC</label>
                  <input autocomplete='off' class='form-control card-cvc' placeholder='ex. 311' size='4' type='text'>
                </div>
                <div class='col-xs-4 form-group expiration required'>
                  <label class='control-label'>Expiration</label>
                  <input class='form-control card-expiry-month' placeholder='MM' size='2' type='text'>
                </div>
                <div class='col-xs-4 form-group expiration required'>
                  <label class='control-label'> </label>
                  <input class='form-control card-expiry-year' placeholder='YYYY' size='4' type='text'>
                </div>
              </div>
              <div class='form-row'>
                <div class='col-md-12'>
                  <div class='form-control total btn btn-success'>
                    Total:
                    <span class='amount'>$2.50</span>
                  </div>
                </div>
              </div>
              <div class='form-row'>
                <div class='col-md-12 form-group'>
                  <button class='form-control btn btn-primary submit-button'>Pay »</button>
                </div>
              </div>
            </div>
        </div>
        <div class='col-md-4'>
          <div class='payment-info panel panel-warning'>
            <div class='panel-heading'>
              <h3 class='panel-title'>Before you give us money!</h3>
            </div>
            <div class='panel-body'>
              <ul>
                <li>Once you give us money there are no take backies.</li>
                <li>We can't give refunds so...think about that $2.50.</li>
                <li>The postcard that is sent may actually offend someone and they might get super mad. So keep that in mind.</li>
                <li>We are not liable for any offense that the receipent takes because of the postcard.</li>
                <li>We are not liable for friendships lost.</li>
                <li>We encourage you spread us around...we may give you some free postcards.</li>
              </ul>
            </div>
          </div>
          <div class='payment-errors panel panel-danger'>
            <div class='panel-heading'>
              <h3 class='panel-title'>Something goofed, check the message below!</h3>
            </div>
            <div class='payment-errors-body panel-body'>
            </div>
          </div>
        </div>
    </div>
        </div>
      </div>
  </div>
</div>  
<div class="modal fade" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false" role="dialog">
  <div class='modal-dialog'>
    <div class='modal-content'>
      <div class="modal-header">
        <h2>Sending a shitty postcard.</h2>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block custom_javascript %}
Handlebars.registerHelper('defaultValue', function (value, defaultValue) {
  var out = value || defaultValue;
  return new Handlebars.SafeString(out);
});

$(document).ready(function(){
  mixpanel.track("Page Load");
  $('.carousel').carousel();
  $('.postcard-buy').hide();
  $('.preview-window').show();
  $('.postcard-address-errors').hide();
  renderPreview();

  Stripe.setPublishableKey('pk_test_ikXDMh2P9wfEH1u8A5qQfFzr');


  $('.postcard-submit').click(function(e){
    e.preventDefault();
    mixpanel.track("Postcard Order Start");

    $.ajax({
      type: 'POST',
      url: '/verify_address',
      data: JSON.stringify(buildRequest()),
      headers: {
        'Content-Type': 'application/json'
      },
      dataType: 'json',
      success: function(data) {
        if (data.error !== undefined) {
          $('.postcard-buy').hide();
          $('.preview-window').show()
          $('.postcard-address-errors').show();
          $('.postcard-address-errors-body').html("<p class='text-danger'>" + data.error + "</p>");
        } else {
          $('.preview-window').hide();
          $('.payment-errors').hide();
          $('.postcard-address-errors').hide();
          $('.postcard-buy').show();

          $('.submit-button').click(function(e){
            e.preventDefault();
            $(this).toggleClass('disabled');

            Stripe.card.createToken({
              number: $('.card-number').val(),
              cvc: $('.card-cvc').val(),
              exp_month: $('.card-expiry-month').val(),
              exp_year: $('.card-expiry-year').val(),
              name: $('.name').val()}, stripeResponseHandler);
          });
        }
      }
    });
  });

  $('.address').change(renderPreview);
});

function renderPreview() {
  var source = $("#postcard-template").html();
  var template = Handlebars.compile(source, {noEscape: true});
  var request = buildRequest();
  var phrases = [
    {% for phrase in phrases %}
      "{{phrase}}",
    {% endfor %}
    "Shitty Letters"
  ];

  var randomNumber = Math.floor(Math.random()*phrases.length);
  request.message = phrases[randomNumber];

  $('.postcard-preview').html(template(request)); 
}

function stripeResponseHandler(status, response) {
  if (response.error) {
   $('.submit-button').toggleClass('disabled');
   $('.payment-info').hide();
   $('.payment-errors').show();
   $('.payment-errors-body').html(response.error.message); 
  } else {
    mixpanel.track("Successful Payment");
    $('.name').val(""); 
    $('.card-number').val("");
    $('.card-cvc').val("");
    $('.card-expiry-month').val("");
    $('.card-expiry-year').val("");
    $(".payment-errors").html(""); 
    $('#pleaseWaitDialog').modal();
    var token = response["id"]

    postcardRequest = buildRequest();
    postcardRequest.card_token = token;

    $.ajax({
      type: 'POST',
      url: '/postcard',
      data: JSON.stringify(postcardRequest),
      headers: {
        'Content-Type': 'application/json'
      },
      dataType: 'json',
      success: function(data) {
        if (data.message !== undefined) {
          if (data.message == "success") {
            mixpanel.track("Postcard Order Finish");
            window.location.replace("/success");
          } else {
            $('#pleaseWaitDialog').modal('hide');
            alert("Something goofed.")
          }
        }
      }
    });
  }
}

function buildRequest() {
  return {
    "full_name": $('#full-name').val(),
    "address1": $('#address-line1').val(),
    "address2": $('#address-line2').val(),
    "city": $('#city').val(),
    "postal_code": $('#postal-code').val(),
    "state": $('#region option:selected').text(),
    "email": $('.email').val()
  }
}

{% endblock %}

